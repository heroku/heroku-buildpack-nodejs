name: CI

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read

jobs:
  unit-test:
    runs-on: ubuntu-22.04
    container:
      image: heroku/heroku:${{ matrix.stack_number }}-build
    strategy:
      matrix:
        stack_number: ["18", "20", "22"]
    steps:
      - uses: actions/checkout@v2
      - name: Run unit tests
        run: test/unit

  unit-test-heroku-build:
    runs-on: ubuntu-22.04
    container:
      image: heroku/heroku:${{ matrix.stack_number }}-build
    strategy:
      matrix:
        stack_number: ["18", "20", "22"]
    steps:
    - uses: actions/checkout@v2
    - name: Test heroku-${{ matrix.stack_number }}-build
      run: test/run

  hatchet-test:
    runs-on: ubuntu-22.04
    container:
      image: ruby:2.7.2
    env:
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      HEROKU_API_USER: ${{ secrets.HEROKU_API_USER }}
    steps:
    - uses: actions/checkout@v2
    - name: Run hatchet tests
      run: make hatchet

  unit-test-binary:
    runs-on: ubuntu-22.04
    container:
      image: golang:1.14
    steps:
    - uses: actions/checkout@v2
    - name: Test Go Binary
      run: make test-binary
